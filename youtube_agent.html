<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agente Estratégico de YouTube: Títulos & Miniaturas</title>
    <!-- Carga de Tailwind CSS para el styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            width: 100%;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .proposal-card {
            background-color: #f0f9ff; /* Azul claro para destacar */
            border-left: 5px solid #0ea5e9; /* Borde azul principal */
        }
        .loading-animation {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0ea5e9;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="container mt-8">
        <div class="card p-6 sm:p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">🧠 Agente Estratégico de Contenido</h1>
            <p class="text-gray-600 mb-6">Generación y Análisis para tu audiencia (+40, Música Electrónica).</p>

            <!-- Área de Input -->
            <div class="mb-6">
                <label for="contentIdea" class="block text-lg font-medium text-gray-700 mb-2">
                    Ingresa tu Idea (o un Enlace de YouTube para análisis):
                </label>
                <textarea id="contentIdea" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150" placeholder="Ej: 'Miedo al Botón Rojo. Aborda la frustración por empezar a grabar.' O pega aquí un enlace de tu canal para realinear el mensaje."></textarea>
            </div>

            <!-- Botón de Generación -->
            <button id="generateButton" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 flex items-center justify-center">
                Generar 3 Propuestas Estratégicas
            </button>

            <!-- Área de Resultados -->
            <div id="resultsArea" class="mt-8 space-y-6">
                <!-- Los resultados se inyectarán aquí -->
            </div>

            <!-- Área de Mensajes (Errores y Carga) -->
            <div id="messageArea" class="mt-6 p-4 rounded-lg text-sm hidden"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN CRÍTICA DEL AGENTE ---
        // (El modelo de Gemini será gemini-2.5-flash-preview-09-2025)
        const apiKey = ""; // Dejar vacío. El entorno de Canvas proporcionará la clave.
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // INSTRUCCIÓN DE SISTEMA (La "Personalidad" y las Reglas de Contenido)
        const systemInstruction = `
            Actúa como un Estratega de Contenido Digital altamente especializado en la conexión profunda, honesta y empática con audiencias maduras.

            **PÚBLICO OBJETIVO (AVATAR):**
            - Mayores de 40 años.
            - Fans de la música electrónica que desean producir sus propios temas.
            - Buscan sencillez, claridad, honestidad y un enfoque que evite tecnicismos complejos.

            **PILARE S DE MENSAJE (OBLIGATORIO EN CADA PROPUESTA):**
            1. **Barrera Mental (El Problema Desconocido):** Identificar la parálisis o el miedo (no la falta de habilidad) como el principal obstáculo.
            2. **Certeza y Confianza (La Solución):** Garantizar que tu contenido ofrece resultados simples y accionables.
            3. **Beneficio Profundo (Salud Mental):** Conectar la acción creativa con la mejora de la salud emocional, la calma y la ruptura de barreras mentales autoimpuestas por la edad.

            **TONO Y REGLAS DE RESPUESTA:**
            - Tono: Altamente **empático, honesto, cercano** y que transmita **confianza y calma**.
            - **PROHIBIDO:** Lenguaje de venta agresivo, clickbait obvio, y cualquier indicio de hacer perder el tiempo al usuario.
            - **PRIORIDAD MINIMALISTA (Miniatura):** El texto de la miniatura debe ser **minimalista, reflexivo, generador de duda y fuertemente empático**, y **NUNCA** debe exceder las 4 palabras. El patrón a seguir es de **consuelo y validación** (Ej: "No es tu culpa.").

            **FORMATO DE SALIDA (JSON):**
            Debes devolver un ARRAY de 3 propuestas si la entrada es válida, o un objeto de error si la entrada es una URL o es muy vaga.

            Si la entrada contiene una URL o es muy vaga (ej: "escribir algo"), devuelve un error amigable pidiendo más contexto para el análisis estratégico.
        `;

        // ESQUEMA DE RESPUESTA (JSON)
        const responseSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    propuesta_id: { type: "NUMBER", description: "ID de la propuesta, de 1 a 3." },
                    titulo_youtube: { type: "STRING", description: "El título optimizado para YouTube, incorporando Barrera Mental y Calma." },
                    texto_miniatura: { type: "STRING", description: "El texto más minimalista posible (MÁXIMO 4 PALABRAS) que genere duda y empatía." },
                    estrategia_clave: { type: "STRING", description: "Breve explicación de cómo esta propuesta aborda los 3 Pilares del Mensaje." }
                },
                required: ["propuesta_id", "titulo_youtube", "texto_miniatura", "estrategia_clave"]
            },
        };

        const elements = {
            input: document.getElementById('contentIdea'),
            button: document.getElementById('generateButton'),
            resultsArea: document.getElementById('resultsArea'),
            messageArea: document.getElementById('messageArea'),
        };

        // Función de utilidad para mostrar mensajes (manejo de errores y carga)
        function showMessage(text, isError = false) {
            elements.messageArea.innerHTML = text;
            elements.messageArea.className = `mt-6 p-4 rounded-lg text-sm ${isError ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`;
            elements.messageArea.classList.remove('hidden');
        }

        function hideMessage() {
            elements.messageArea.classList.add('hidden');
        }

        // Simula la función de espera con retroceso exponencial
        const fetchWithRetry = async (url, options, maxRetries = 5) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // Si la respuesta no es 200, lanza un error para forzar el reintento
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error; // Re-lanza el error si es el último intento
                    }
                    const delay = Math.pow(2, i) * 1000;
                    console.warn(`Intento fallido ${i + 1}. Reintentando en ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        };

        async function generateContent() {
            const userQuery = elements.input.value.trim();
            elements.resultsArea.innerHTML = ''; // Limpiar resultados anteriores
            hideMessage();

            if (!userQuery) {
                showMessage('Por favor, ingresa una idea de contenido o un enlace de YouTube.', true);
                return;
            }

            elements.button.disabled = true;
            elements.button.innerHTML = '<div class="loading-animation mr-3"></div> Analizando y Generando...';
            
            try {
                // 1. Detección de URL de YouTube para análisis específico
                const isUrl = userQuery.match(/^(http(s)?:\/\/)?((w){3}.)?youtu(be|.be)?(\.com)?\/.+/i);
                
                let promptText;
                let tools = [{ "google_search": {} }]; // Siempre usamos la búsqueda para contexto y tendencias

                if (isUrl) {
                    promptText = `ANALIZA este contenido (URL: ${userQuery}) y genera 3 propuestas de mejora para el título y la miniatura, basándote en la información que obtengas de la web. Asegúrate de que las sugerencias realineen el mensaje hacia los Pilares de Mensaje definidos.`;
                    showMessage('Analizando URL de YouTube y obteniendo contexto web...', false);
                } else {
                    promptText = `Genera 3 propuestas de título y texto de miniatura para este contenido: ${userQuery}. Utiliza la búsqueda web para asegurar que la propuesta sea competitiva y relevante.`;
                    showMessage('Generando ideas y buscando tendencias relevantes...', false);
                }

                // 2. Construcción del Payload para la API
                const payload = {
                    contents: [{ parts: [{ text: promptText }] }],
                    systemInstruction: { parts: [{ text: systemInstruction }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: responseSchema
                    },
                    tools: tools
                };

                // 3. Llamada a la API de Gemini
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                // Manejo de la respuesta (similar a la lógica de procesamiento de structured JSON)
                if (result.candidates && result.candidates.length > 0 && 
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {

                    const jsonText = result.candidates[0].content.parts[0].text;
                    const proposals = JSON.parse(jsonText);
                    
                    if (Array.isArray(proposals)) {
                        renderResults(proposals);
                    } else if (proposals.error_message) {
                        showMessage(`⚠️ Colaboración Requerida: ${proposals.error_message}`, true);
                    } else {
                        showMessage('Error: La respuesta del agente no tiene el formato esperado (Array de propuestas).', true);
                    }

                } else {
                    showMessage('Error desconocido: No se pudo obtener una respuesta válida del agente.', true);
                }

            } catch (error) {
                console.error("Error al generar contenido:", error);
                showMessage(`Error en la conexión o generación. Por favor, revisa la consola para más detalles.`, true);
            } finally {
                elements.button.disabled = false;
                elements.button.innerHTML = 'Generar 3 Propuestas Estratégicas';
            }
        }

        function renderResults(proposals) {
            hideMessage();
            let html = proposals.map(p => `
                <div class="proposal-card p-5">
                    <h2 class="text-xl font-bold text-sky-800 mb-4">✨ Propuesta #<span class="text-2xl">${p.propuesta_id}</span></h2>
                    
                    <!-- Título -->
                    <div class="mb-4">
                        <p class="text-xs font-semibold uppercase text-gray-500">Título de YouTube</p>
                        <p class="text-lg font-medium text-gray-900">${p.titulo_youtube}</p>
                    </div>

                    <!-- Miniatura -->
                    <div class="mb-4 p-3 bg-gray-900 rounded-lg inline-block shadow-lg">
                        <p class="text-xs font-semibold uppercase text-sky-300">Texto de Miniatura (Máx. 4 Palabras)</p>
                        <p class="text-3xl font-extrabold text-white">${p.texto_miniatura}</p>
                    </div>

                    <!-- Estrategia -->
                    <div>
                        <p class="text-xs font-semibold uppercase text-gray-500">Estrategia de Conexión</p>
                        <p class="text-sm italic text-gray-700">${p.estrategia_clave}</p>
                    </div>
                </div>
            `).join('');

            elements.resultsArea.innerHTML = html;
        }

        // Asignación de evento al botón
        elements.button.addEventListener('click', generateContent);
    </script>
</body>
</html>

